var Color=new Native({initialize:function(a,c){if(arguments.length>=3){c="rgb";a=Array.slice(arguments,0,3)}else if(typeof a=="string")a=a.match(/rgb/)?a.rgbToHex().hexToRgb(true):a.match(/hsb/)?a.hsbToRgb():a.hexToRgb(true);c=c||"rgb";switch(c){case "hsb":var b=a;a=a.hsbToRgb();a.hsb=b;break;case "hex":a=a.hexToRgb(true);break}a.rgb=a.slice(0,3);a.hsb=a.hsb||a.rgbToHsb();a.hex=a.rgbToHex();return $extend(a,this)}}); Color.implement({mix:function(){var a=Array.slice(arguments),c=$type(a.getLast())=="number"?a.pop():50,b=this.slice();a.each(function(d){d=new Color(d);for(var e=0;e<3;e++)b[e]=Math.round(b[e]/100*(100-c)+d[e]/100*c)});return new Color(b,"rgb")},invert:function(){return new Color(this.map(function(a){return 255-a}))},setHue:function(a){return new Color([a,this.hsb[1],this.hsb[2]],"hsb")},setSaturation:function(a){return new Color([this.hsb[0],a,this.hsb[2]],"hsb")},setBrightness:function(a){return new Color([this.hsb[0], this.hsb[1],a],"hsb")}});var $RGB=function(a,c,b){return new Color([a,c,b],"rgb")},$HSB=function(a,c,b){return new Color([a,c,b],"hsb")},$HEX=function(a){return new Color(a,"hex")}; Array.implement({fromRgb:function(a,c){var b,d=0,e=$A(this).sort(function(h,j){return res=h-j}),f=e[0];b=e[2];switch((a||"").toLowerCase().slice(-1)){default:span=b=b/2.55;break;case "g":b=f/(f-b+255)*100;span=100;break;case "l":b=(+b+ +f)/5.1;span=b*2;if(b>50){span=200-span;d=100-span}}f=100*(f/2.55-b)/(d-b);d=(100*(e[1]/2.55-b)/f+b-d)/span;for(var g="",i=0;i<3;i++)g+=e.indexOf(this[i]);e="210,120,021,012,102,201,110,020,011,002,101,000,200".indexOf(g)/4%6;e+=e%2?1-d:d;return[e*60,f,b].map(function(h){return c? h||0:Math.round(h||0)})},toRgb:function(a,c){var b=0,d=[],e=+this[2],f=e,g=this[0]%360/60,i=Math.floor(g);g=[0,i%2?1+i-g:g-i,1];var h=["210","201","021","012","102","120"][i];switch((a||"").slice(-1).toLowerCase()){case "w":case "g":e=100;break;case "l":case "i":e*=2;if(f>50){e=200-e;b=100-e}}g.each(function(j,k){var l=2.55*(this[1]/100*(j*e-f+b)+f);d[h.charAt(k)]=c?l:Math.round(l)},this);return d}}); String.implement({fromRgb:function(a){var c=this.match(/\d{1,3}/g);return c?c.fromRgb(a):null},toRgb:function(a){var c=this.match(/\d{1,3}/g);return c?c.toRgb(a):null}}); ["b","l","w","v","i","g"].each(function(a){String.implement("hs"+a+"ToRgb",function(){var c=this.match(/\d{1,3}/g);return c?c.toRgb(a):null});String.implement("rgbToHs"+a,function(){var c=this.match(/\d{1,3}/g);return c?c.fromRgb(a):null});Array.implement("rgbToHs"+a,function(c){return this.fromRgb(a,c)});Array.implement("hs"+a+"ToRgb",function(c){return this.toRgb(a,c)})}); var CRImages="../Source/Assets/",ColorRoller=new Class({Implements:[Options,Events],options:{onComplete:$empty,onCancel:$empty,onChange:$empty,onShow:$empty,space:"W",color:[127,127,127],type:0,colorswitch:true},initialize:function(a){this.setOptions(a);this.build();a=this.els;var c=this.options.color;this.barHeight=a.crBar.getSize().y;this.boxH=this.boxW=a.crBox.getSize().y;this.radius=a.crBox.getSize().x/2;this.vLast=+(this.options.type<2);this.setRGB($type(c)=="string"?c.hexToRgb(1):c,3);a.crIcon0.setStyle("background-color", c.rgbToHex());a.crFrame.setStyle("height",0);this.addEvents();this.wheel();return a.crColorRoller},build:function(){var a=this,c=0,b=this.els={};$each({Space:"select",Type:"select",Img:"img",Show:"img",View:"span",Icon:"span",ColorRoller:"span",Apply:"span",Draw:"canvas"},function(e,f){b["cr"+f]=new Element(e,{"class":"cr"+f})});$each({0:"Wheel",1:"MS Paint",2:"Adobe CS",3:"Triangle",W:"HSW",B:"HSB/V",L:"HSL/I"},function(e,f){(new Element("option",{value:f,text:e,"class":"crO"+f})).inject(++c>4?b.crSpace: b.crType)});["ColorPicker","Frame","Head","Box","BoxSel","BoxSee","Bar","BarSel","Nums","Val","Icon0","Icon1","Icon2","Circle","Shape","Shade","L0","L1","L2","Cancel","X","V","Bot"].each(function(e){b["cr"+e]=new Element("div",{"class":"cr"+e})});$each({R:"inputRGB",G:"inputRGB",B:"inputRGB",0:"input0",S:"inputS",1:"input1",Hex:"inputRGBHex"},function(e,f){if(f==0)f=0;b["cr"+f]=new Element("span",{text:f||"H","class":"cr"+f||"H"});b["crI"+f]=new Element("input",{type:"text","class":"crI"+f});b["crI"+ f].addEvent("keyup",a[e].bind(a));b["crA1"+f]=new Element("span");b["crA2"+f]=new Element("span");b["crD"+f]=(new Element("span",{"class":"crD"})).adopt(b["cr"+f],b["crI"+f])});with(b)crColorRoller.adopt(crIcon.adopt(crIcon0,crIcon1.adopt(crIcon2)),crFrame.set("morph",{duration:"long",link:"cancel"}).adopt(crColorPicker.adopt(crHead.adopt(crCancel.adopt(crX.set("html","+"))),crBox.adopt(crL0,crL1,crL2,crBoxSel.adopt(crBoxSee),crShape,crShade),crBar.adopt(crBarSel),crNums.adopt(crSpace,crType,crVal.adopt(crDR, crD0,crDG,crDS,crDB,crD1)),crBot.adopt(crDHex,crView,crApply.addClass("crD").set("html","Apply")))).addClass(Browser.Engine.name)).inject(document.body);if(Browser.Engine.trident)for(var d=0;d<12;d++)(new Element("div",{"class":"crIE"+d})).inject(b[d<6?"crL1":"crBar"])},addEvents:function(){function a(d){c.mousedown=true;d.stop()}var c=this,b=this.els;b.crSpace.addEvent("change",this.setSpace.bind(this)).fireEvent("change");b.crType.addEvent("change",this.setType.bind(this)).fireEvent("change");b.crIcon.addEvent("click", this.toggle.bind(this));b.crApply.addEvent("click",this.close.pass(1,c));b.crCancel.addEvent("click",this.close.pass(0,c));b.crColorPicker.addEvent("mouseup",function(){c.mousedown=false});b.crBarSel.addEvents("mousedown",a);b.crBar.addEvents({mousemove:c.slider.bind(c),mousedown:function(d){a(d);c.slider(d)}});b.crShade.addEvents({mousemove:c.picker.bind(c),mousedown:function(d){a(d);c.picker(d)}})},inputRGB:function(){this.setRGB(this.getValues(["R","G","B"]),1)},inputRGBHex:function(a){this.setRGB(a.target.value.hexToRgb(1), 2)},input0:function(a){this.inputHSV(0,a.target.value)},inputS:function(a){this.setPicker(this.els["crI"+ +!this.vLast].get("value"),a.target.value,1)},input1:function(a){this.inputHSV(1,a.target.value)},inputHSV:function(a,c){this.vLast!=a?this.setPicker(c,this.getValues(["S"]),1):this.setSlider(c,1)},slider:function(a){var c=this.vLast?100:360;a=c-c*(a.page.y-this.offset.y)/this.barHeight;this.mousedown&&a>-1&&a<c&&this.setSlider(a,2)},picker:function(a){if(this.mousedown){var c=this.els,b,d,e= a.page.x-this.offset.x;a=a.page.y-this.offset.y;if(this.type)if(this.type<3){b=(this.vLast?360:100)*e/this.boxH;d=100-100*a/this.boxH}else{switch(this.space){case "W":b=((a-this.boxH)/2+e)/a;d=1-a/this.boxH;break;case "L":d=(this.boxH-a)/(2*(e>this.boxH/2?this.boxH-e:e));b=e/this.boxH;break;case "B":d=this.boxH-(this.boxH-a)/2-e;b=1-d/this.boxH;d=1-(a-d)/(this.boxH-d)}b*=100;d*=100;if(b>100||b<0)return}else{d=e-this.radius;var f=this.radius-a;b=Math.atan2(d,f)*180/Math.PI;d=Math.sqrt(d*d+f*f)*100/ this.radius;if(b<0)b+=360}if(!(d>100)){c.crBoxSel.setPosition({y:a,x:e});this.setPicker(b,d,2)}}},setRGB:function(a,c){var b=this.els,d=a.rgbToHex().toUpperCase();this.fireEvent("change",d);c!=1&&this.setValues(["R","G","B"],a);c!=2&&b.crIHex.set("value",d);b.crView.setStyle("background-color","rgb("+a+")");if(c){b=a.fromRgb(this.space);this.vLast||b.reverse();this.setPicker(b[0],b[1]);this.setSlider(b[2])}},setPicker:function(a,c,b){b!=1&&this.setValues([+!this.vLast,"S"],[a,c],5);if(b!=2){if(this.type)if(this.type< 3){f=this.boxH-c*this.boxH/100;g=a*this.boxH/(this.vLast?360:100)}else{var d=c/100;e=2;g=this.boxW*a/100;switch(this.space){case "L":f=this.boxH-(this.boxH-e*((a<50?this.boxW-g:g)-this.boxW/2))*d;break;case "B":f=this.boxH-e*g;g-=g*d*0.5;f=g*e+f;break;case "W":g-=d*(g-this.boxW*0.5);f=this.boxH-this.boxH*d}}else{var e=a*Math.PI/180;d=c*this.radius/100;var f=this.radius-d*Math.cos(e),g=this.radius+d*Math.sin(e)}this.els.crBoxSel.setStyles({top:f,left:g})}if(b)this.setRGB((this.vLast?[a,c,this.val]: [this.val,c,a]).toRgb(this.space))},setSlider:function(a,c){var b=this.els;if(this.vLast){var d=Math.round(a*2.55);d=[d,d,d];b.crL2.setStyles({"background-color":d,opacity:this.space=="B"?1-a/100:this.space=="L"?Math.abs(a/50-1):0})}else d=[a,100,100].toRgb();this.val=a;b.crBarSel.setStyle("top",100-a/(this.vLast||3.6)+"%");Browser.Engine.gecko&&(this.space=="W"||this.type!=2)?b.crL1.setStyle("background-image","-moz-"+(this.type?"linear-gradient("+(this.vLast?"bottom":"top"):"radial-gradient(center center, circle closest-side")+ ",rgb("+d+"),transparent)"):b.crL0.setStyle("background-color","rgb("+d+")");c!=1&&b["crI"+this.vLast].set("value",Math.round(a));c&&this.setRGB(this.getValues([0,"S",1]).toRgb(this.space))},getValues:function(a){var c=this;return a.map(function(b){return c.els["crI"+b].get("value")})},setValues:function(a,c){var b=this;c.each(function(d,e){b.els["crI"+a[e]].set("value",Math.round(d))})},setSpace:function(a){var c=+!this.vLast,b=this.getValues([this.vLast,c]);this.space=a?a.target.value:this.options.space; a||this.els.crSpace.set("value",this.space);this.els.cr1.set("text",this.space);this.options.colorswitch?this.inputRGB():this.setSlider(b[0])||this.inputHSV(c,b[1]);this.type==2&&this.setImg()},setType:function(a){var c=this.els,b=this.type=a?+a.target.value:this.options.type;a||this.els.crType.set("value",b);this.vLast=+(b<2);c.crBar.addClass("bar"+this.vLast).removeClass("bar"+ +!this.vLast);c.crBox[b?"removeClass":"addClass"]("crRound");c.crBox.setStyle("background-color","");this.setImg(["wheel", "paint",false,"triangle"][b]);this.vLast||c.crL2.setStyles({"background-color":"",opacity:1});this.inputRGB()},setImg:function(){var a=this.els;[0,1,2].each(function(c){var b="crL"+c;a["crL"+c].set("class",b+" "+(b+=this.type)+" "+b+this.space)},this);this.els.crShape.set("class","crShape crShape"+this.type)},toggle:function(){this[this.els.crFrame.getStyle("height")=="0px"?"show":"close"]()},show:function(){this.els.crFrame.morph({height:152});this.offset={y:this.els.crBox.getPosition().y,x:this.els.crBox.getPosition().x}; this.fireEvent("show")},close:function(a){var c=this.getValues(["R","G","B"]).rgbToHex().toUpperCase();this.els.crFrame.morph({height:0});a&&this.els.crIcon0.setStyle("background-color",c);this.fireEvent(a?"complete":"cancel",c)},draw:function(){if(!Browser.Engine.trident){for(var a=Browser.Engine.gecko?this.els.crDraw.set({width:this.boxH,height:this.boxH}).inject(this.els.crL0,"before").getContext("2d"):document.getCSSCanvasContext("2d","circle",100,100),c=a.createImageData(this.boxH,this.boxW), b=c.data,d=this.radius,e=this.boxH-1,f=e,g=e,i=b.length-4;i>0;i-=4){var h=Math.atan2(f-d,d-g)*0.954929658551372;if(h<0)h+=6;var j=Math.floor(h);h=[0,Math.round(255*(j%2?1+j-h:h-j)),255];j=["210","201","021","012","102","120"][j];for(var k=0;k<3;k++)b[i+ +j[k]]=h[k];b[i+3]=255;if(!f--&&g--)f=e}a.putImageData(c,0,0);a.globalCompositeOperation="destination-out";a.beginPath();a.arc(d,d,d+10,6.2,0,true);a.lineWidth=20;a.stroke()}},wheel:function(){var a,c=this.radius,b=this.boxH-1,d=b,e=b,f=false;switch(Browser.Engine.name){case "webkit":a= document.getCSSCanvasContext("2d","circle",100,100);break;case "trident":this.els.crL1.adopt(this.els.crCircle);this.els.crShape.set("html",'<v:group style="width:100; height:100;" coordsize = "100,100"><v:oval style="width:120;height:120" filled="false" stroked=t strokeweight=20 strokecolor=silver /></v:group>');a='<v:group style="width:'+this.boxW+";height:"+this.boxH+'" coordsize="'+this.boxW+","+this.boxH+'">';break;case "gecko":a=this.els.crDraw.set({width:this.boxH,height:this.boxH}).inject(this.els.crL0, "before").getContext("2d");a.mozImageSmoothingEnabled=false}a.lineWidth=3;for(var g=b*4;g>0;g--){var i=Math.atan2(d-c,c-e)*0.954929658551372;if(i<0)i+=6;var h=Math.floor(i),j=[];i=[0,Math.round(255*(h%2?1+h-i:i-h)),255];h=["210","201","021","012","102","120"][h];for(var k=0;k<3;k++)j[h.charAt(k)]=i[k];j=j[0]+","+j[1]+","+j[2];if(Browser.Engine.trident)a+='<v:line from="'+c+","+c+'" to="'+d+","+e+'" strokecolor=rgb('+j+") />";else{a.beginPath();a.strokeStyle="rgb("+j+")";a.moveTo(c,c);a.lineTo(d,e); a.stroke()}d||e||(f=true);f?d<b?++d:++e:d?--d:--e}if(Browser.Engine.trident)this.els.crCircle.innerHTML=a+"</v:group>";else{a.globalCompositeOperation="destination-out";a.beginPath();a.lineWidth=20;a.arc(c,c,c+10,Math.PI*2,0,true);a.stroke()}}});